<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Erreurs de Charge</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/components/header.css">
    <link rel="stylesheet" href="/static/css/components/filters.css">
    <link rel="stylesheet" href="/static/css/components/tabs.css">
    <link rel="stylesheet" href="/static/css/components/kpi-cards.css">
    <link rel="stylesheet" href="/static/css/components/buttons.css">
    <link rel="stylesheet" href="/static/css/components/charts.css">
    <link rel="stylesheet" href="/static/css/components/cards.css">
    <link rel="stylesheet" href="/static/css/pages/alertes.css">
    <link rel="stylesheet" href="/static/css/pages/evolution.css">
    <link rel="stylesheet" href="/static/css/pages/defauts-historique.css">
    <link rel="stylesheet" href="/static/css/pages/multi-attempts.css">
    <link rel="stylesheet" href="/static/css/pages/suspicious.css">
    <link rel="stylesheet" href="/static/css/pages/report-generator.css">
    <link rel="stylesheet" href="/static/css/pages/report.css">
    <link rel="stylesheet" href="/static/css/pages/sessions-general.css">
    <link rel="stylesheet" href="/static/css/pages/sessions_stats.css">
    <link rel="stylesheet" href="/static/css/pages/sessions_comparaison.css">
    <link rel="stylesheet" href="/static/css/pages/sessions_site_details.css">
    <link rel="stylesheet" href="/static/css/pages/error_analysis.css">
    <link rel="stylesheet" href="/static/css/pages/projection.css">
    <link rel="stylesheet" href="/static/css/pages/code_analysis.css">
    <link rel="stylesheet" href="/static/css/pages/code_results.css">
    <link rel="stylesheet" href="/static/css/pages/mac-address.css">
    <link rel="stylesheet" href="/static/css/pages/tableau-charges.css">
</head>
<body>
    <header class="header">
        <div class="header-logo">‚ö° ELTO</div>
        <div class="header-center">
            <div class="header-title">Dashboard Erreurs de Charge</div>
           <img src="/assets/nidec.png" alt="Nidec Logo" class="header-nidec-logo">
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="background: #f1f5f9; color: var(--color-text); border-radius: 16px; padding: 0.4rem 0.8rem; font-weight: 600; font-size: 0.9rem;">
                üë§ {{ user.username }}
            </div>
            <div>Mise √† jour: <span id="update-time">--:--</span></div>
            <button class="btn" id="logout-btn" type="button">D√©connexion</button>
        </div>
    </header>

    <main class="main">
        <section class="filters">
            <!-- Sites -->
            <div class="filter-row">
                <button class="btn" onclick="toggleAllSites()" id="btn-all-sites">‚òë Tous les sites</button>
                <div class="tags-box" id="sites-tags"></div>
            </div>
            
            <!-- P√©riode -->
            <div class="filter-label">üìÖ P√©riode d'analyse</div>
            <div class="filter-row period-btns">
                <button class="btn" data-mode="focus_jour" onclick="setDateMode('focus_jour')">Focus Jour</button>
                <button class="btn active" data-mode="focus_mois" onclick="setDateMode('focus_mois')">Focus Mois</button>
                <button class="btn" data-mode="j_minus_1" onclick="setDateMode('j_minus_1')">J-1 (Hier)</button>
                <button class="btn" data-mode="semaine_minus_1" onclick="setDateMode('semaine_minus_1')">Semaine -1</button>
                <button class="btn" data-mode="toute_periode" onclick="setDateMode('toute_periode')">Toute la p√©riode</button>
                <button class="btn" data-mode="selection_manuelle" onclick="setDateMode('selection_manuelle')">S√©lection manuelle</button>
            </div>
            
            <!-- Month selector -->
            <div class="filter-row month-selector" id="month-selector">
                <div>
                    <div class="filter-label">Ann√©e</div>
                    <select class="select-input" id="year-select" onchange="updateDates()">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div>
                    <div class="filter-label">Mois</div>
                    <div class="month-radios" id="month-radios"></div>
                </div>
            </div>
            
            <!-- Day selector -->
            <div class="filter-row" id="day-selector" style="display:none;">
                <div>
                    <div class="filter-label">S√©lectionner une date</div>
                    <input type="date" class="select-input" id="day-input" onchange="updateDates()">
                </div>
            </div>
            
            <!-- Manual date range selector -->
            <div class="filter-row" id="manual-date-selector" style="display:none;">
                <div>
                    <div class="filter-label">Date de d√©but</div>
                    <input type="date" class="select-input" id="date-debut-input" onchange="updateDates()">
                </div>
                <div>
                    <div class="filter-label">Date de fin</div>
                    <input type="date" class="select-input" id="date-fin-input" onchange="updateDates()">
                </div>
            </div>
            
            <!-- Period summary -->
            <div class="summary" id="period-summary">üìÖ Mois complet : December 2025</div>
            
            <!-- Global summary -->
            <div class="summary-bar">
                <span><strong>P√©riode:</strong> <span id="sum-dates">--</span></span>
                <span><strong>Sites:</strong> <span id="sum-sites">--</span></span>
            </div>
            
            <!-- Error filters -->
            <div class="filter-row-errors">
                <div>
                    <div class="filter-label">Type d'erreur (global)</div>
                    <div class="tags-box" id="error-type-tags"></div>
                </div>
                <div>
                    <div class="filter-label">Moment d'erreur</div>
                    <div class="tags-box" id="moment-tags"></div>
                </div>
                <div class="toggles">
                    <div class="toggle-row">
                        <label class="toggle">
                            <input type="checkbox" id="toggle-avant" checked onchange="onToggle()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">‚ö° Avant charge</span>
                    </div>
                    <div class="toggle-row">
                        <label class="toggle">
                            <input type="checkbox" id="toggle-charge" checked onchange="onToggle()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">üîã Charge</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="tabs-section">
            <div class="tabs-nav">
                <a href="/dashboard/overview" class="tab-btn active" data-tab="overview">üìä Vue d'ensemble</a>
                <a href="/dashboard/general" class="tab-btn" data-tab="general">üìã G√©n√©rale</a>
                <a href="/dashboard/details-site" class="tab-btn" data-tab="details-site">üîå D√©tails Site</a>
                <a href="/dashboard/comparaison" class="tab-btn" data-tab="comparaison">üè¢ Comparaison</a>
                <a href="/dashboard/stats" class="tab-btn" data-tab="stats">üìà Statistiques</a>
                <a href="/dashboard/analyse-erreur" class="tab-btn" data-tab="analyse-erreur">üîç Analyse Erreur</a>
                <a href="/dashboard/code-analysis" class="tab-btn" data-tab="code-analysis">üîç Codes</a>
                <a href="/dashboard/projection" class="tab-btn" data-tab="projection">üìë Projection</a>
                <a href="/dashboard/mac-address" class="tab-btn" data-tab="mac-address">üîê MAC Address</a>
                <a href="/dashboard/tentatives" class="tab-btn" data-tab="tentatives">‚ö†Ô∏è Multi-tentatives</a>
                <a href="/dashboard/suspectes" class="tab-btn" data-tab="suspectes">‚ö†Ô∏è Transactions < 1 kWh</a>
                <a href="/dashboard/alertes" class="tab-btn" data-tab="alertes">‚ö†Ô∏è Erreurs r√©currentes</a>
                <a href="/dashboard/evolution" class="tab-btn" data-tab="evolution">üìà Evolution</a>
                <a href="/dashboard/historique" class="tab-btn" data-tab="historique">üìã Historique</a>
                <a href="/dashboard/tableau-charges" class="tab-btn" data-tab="tableau-charges">üìã Tableau charges</a>
                <a href="/dashboard/rapport" class="tab-btn" data-tab="rapport">üìÑ Rapport Client</a>
            </div>
            <div id="tab-content">
                <div class="loading"><span class="spinner"></span> Chargement...</div>
            </div>
        </section>
    </main>

    <script>
        // State
        const state = {
            tab: '{{ initial_tab|default("overview") }}',
            dateMode: 'focus_mois',
            dateDebut: null,
            dateFin: null,
            allSites: [],
            sites: [],
            projectionSites: [],
            projectionHideEmpty: false,
            errorTypes: [],
            selectedErrorTypes: [],
            moments: [],
            selectedMoments: [],
            siteFocus: '',
            siteDetailsPdcs: [],
            macSearchState: null,
            codeAnalysisState: null,
        };

        const MOMENT_GROUPS = {
            avant: ['Init', 'Lock Connector', 'CableCheck'],
            charge: ['Charge'],
        };
        
        const endpoints = {
            'overview': '/api/tab/overview',
            'general': '/api/sessions/general',
            'comparaison': '/api/sessions/comparaison',
            'details-site': '/api/sessions/site-details',
            'stats': '/api/sessions/stats',
            'analyse-erreur': '/api/sessions/error-analysis',
            'rapport': '/api/report',
            'code-analysis': '/api/mac-address/code-analysis',
            'projection': '/api/sessions/projection',
            'mac-address': '/api/mac-address',
            'tentatives': '/api/kpi/multi-attempts',
            'suspectes': '/api/kpi/suspicious',
            'alertes': '/api/alertes',
            'evolution': '/api/kpi/evolution',
            'historique': '/api/defauts-historique',
            'tableau-charges': '/api/sessions/tableau-charges',
            'rapport': '/api/report',
        };
        
        // Init month radios
        const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sept', 'Oct', 'Nov', 'D√©c'];
        document.getElementById('month-radios').innerHTML = months.map((m, i) => 
            `<label class="month-radio"><input type="radio" name="month" value="${i+1}" ${i+1 === new Date().getMonth()+1 ? 'checked' : ''} onchange="updateDates()"> ${m}</label>`
        ).join('');
        
        // Load sites
        async function loadSites() {
            const res = await fetch('/api/filters/sites');
            const data = await res.json();
            state.allSites = data.sites || [];
            state.sites = [...state.allSites];
            if (!state.siteFocus && state.allSites.length) {
                state.siteFocus = state.allSites[0];
            }
            renderSites();
        }
        
        function renderSites() {
            document.getElementById('sites-tags').innerHTML = state.allSites.map(s => {
                const isSelected = state.sites.includes(s);
                return `<span class="tag ${isSelected ? '' : 'inactive'}" onclick="toggleSite('${s}')">${s} <button class="tag-remove" onclick="event.stopPropagation(); toggleSite('${s}')">${isSelected ? '√ó' : '+'}</button></span>`;
            }).join('');
            document.getElementById('btn-all-sites').textContent = 
                state.sites.length === state.allSites.length ? '‚òë Tous les sites' : '‚òê Tous les sites';
            document.getElementById('sum-sites').textContent = state.sites.length;
        }
        
        function toggleAllSites() {
            state.sites = state.sites.length === state.allSites.length ? [] : [...state.allSites];
            renderSites();
            onFiltersChange();
        }
        
        function toggleSite(site) {
            if (state.sites.includes(site)) {
                state.sites = state.sites.filter(s => s !== site);
            } else {
                state.sites = [...state.sites, site].sort((a, b) => {
                    const idxA = state.allSites.indexOf(a);
                    const idxB = state.allSites.indexOf(b);
                    return idxA - idxB;
                });
            }
            renderSites();
            onFiltersChange();
        }
        
        // Garder removeSite pour compatibilit√© si utilis√© ailleurs
        function removeSite(site) {
            toggleSite(site);
        }
        
        // Load filter options
        async function loadFilterOptions() {
            const params = new URLSearchParams();
            if (state.sites.length < state.allSites.length) params.set('sites', state.sites.join(','));
            if (state.dateDebut) params.set('date_debut', state.dateDebut);
            if (state.dateFin) params.set('date_fin', state.dateFin);
            
            const res = await fetch(`/api/filters/options?${params}`);
            const data = await res.json();
            
            state.errorTypes = data.error_types || [];
            state.moments = data.moments || [];
            
            if (!state.selectedErrorTypes.length) state.selectedErrorTypes = [...state.errorTypes];
            else state.selectedErrorTypes = state.selectedErrorTypes.filter(t => state.errorTypes.includes(t));
            
            if (!state.selectedMoments.length) state.selectedMoments = [...state.moments];
            else state.selectedMoments = state.selectedMoments.filter(m => state.moments.includes(m));
            
            renderErrorTypes();
            renderMoments();
            updateToggles();
        }
        
        function renderErrorTypes() {
            document.getElementById('error-type-tags').innerHTML = state.errorTypes.map(t => {
                const isSelected = state.selectedErrorTypes.includes(t);
                const label = t.length > 18 ? t.slice(0, 18) + '...' : t;
                return `<span class="tag ${isSelected ? '' : 'inactive'}" onclick="toggleErrorType('${t}')">${label} <button class="tag-remove" onclick="event.stopPropagation(); toggleErrorType('${t}')">${isSelected ? '√ó' : '+'}</button></span>`;
            }).join('');
        }

        function toggleErrorType(type) {
            if (state.selectedErrorTypes.includes(type)) {
                state.selectedErrorTypes = state.selectedErrorTypes.filter(t => t !== type);
            } else {
                state.selectedErrorTypes = [...state.selectedErrorTypes, type];
            }
            renderErrorTypes();
            refreshTab();
        }

        function renderMoments() {
            document.getElementById('moment-tags').innerHTML = state.moments.map(m => {
                const isSelected = state.selectedMoments.includes(m);
                return `<span class="tag ${isSelected ? '' : 'inactive'}" onclick="toggleMoment('${m}')">${m} <button class="tag-remove" onclick="event.stopPropagation(); toggleMoment('${m}')">${isSelected ? '√ó' : '+'}</button></span>`;
            }).join('');
        }

        function toggleMoment(moment) {
            if (state.selectedMoments.includes(moment)) {
                state.selectedMoments = state.selectedMoments.filter(m => m !== moment);
            } else {
                state.selectedMoments = [...state.selectedMoments, moment];
            }
            renderMoments();
            updateToggles();
            refreshTab();
        }
        
        function onToggle() {
            let newMoments = [];
            if (document.getElementById('toggle-avant').checked) 
                newMoments.push(...MOMENT_GROUPS.avant.filter(m => state.moments.includes(m)));
            if (document.getElementById('toggle-charge').checked) 
                newMoments.push(...MOMENT_GROUPS.charge.filter(m => state.moments.includes(m)));
            if (state.moments.includes('Unknown')) newMoments.push('Unknown');
            
            state.selectedMoments = newMoments;
            renderMoments();
            refreshTab();
        }
        
        function updateToggles() {
            const hasAvant = MOMENT_GROUPS.avant.every(m => !state.moments.includes(m) || state.selectedMoments.includes(m));
            const hasCharge = !state.moments.includes('Charge') || state.selectedMoments.includes('Charge');
            document.getElementById('toggle-avant').checked = hasAvant;
            document.getElementById('toggle-charge').checked = hasCharge;
        }
        
        // Dates
        function setDateMode(mode) {
            state.dateMode = mode;
            document.querySelectorAll('.period-btns .btn').forEach(b => 
                b.classList.toggle('active', b.dataset.mode === mode));
            document.getElementById('month-selector').style.display = mode === 'focus_mois' ? 'flex' : 'none';
            document.getElementById('day-selector').style.display = mode === 'focus_jour' ? 'block' : 'none';
            document.getElementById('manual-date-selector').style.display = mode === 'selection_manuelle' ? 'flex' : 'none';
            
            // Initialiser les dates par d√©faut pour la s√©lection manuelle si elles sont vides
            if (mode === 'selection_manuelle') {
                const dateDebutInput = document.getElementById('date-debut-input');
                const dateFinInput = document.getElementById('date-fin-input');
                if (!dateDebutInput.value) {
                    const today = new Date();
                    dateDebutInput.value = fmt(today);
                }
                if (!dateFinInput.value) {
                    const today = new Date();
                    dateFinInput.value = fmt(today);
                }
            }
            
            updateDates();
        }
        
        function updateDates() {
            const today = new Date();
            const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
            
            switch(state.dateMode) {
                case 'focus_jour':
                    const day = document.getElementById('day-input').value || fmt(today);
                    state.dateDebut = state.dateFin = day;
                    break;
                case 'focus_mois':
                    const year = document.getElementById('year-select').value;
                    const month = document.querySelector('input[name="month"]:checked')?.value || today.getMonth()+1;
                    const first = new Date(year, month-1, 1);
                    const last = new Date(year, month, 0);
                    state.dateDebut = fmt(first);
                    state.dateFin = fmt(last);
                    break;
                case 'j_minus_1':
                    state.dateDebut = state.dateFin = fmt(yesterday);
                    break;
                case 'semaine_minus_1':
                    const week = new Date(yesterday); week.setDate(week.getDate() - 6);
                    state.dateDebut = fmt(week);
                    state.dateFin = fmt(yesterday);
                    break;
                case 'toute_periode':
                    state.dateDebut = '{{ date_min }}';
                    state.dateFin = '{{ date_max }}';
                    break;
                case 'selection_manuelle':
                    const dateDebutInput = document.getElementById('date-debut-input');
                    const dateFinInput = document.getElementById('date-fin-input');
                    state.dateDebut = dateDebutInput.value || fmt(today);
                    state.dateFin = dateFinInput.value || fmt(today);
                    break;
            }
            updateSummary();
            onFiltersChange();
        }
        
        function fmt(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function updateSummary() {
            const monthNames = [
            'Janvier',
            'F√©vrier',
            'Mars',
            'Avril',
            'Mai',
            'Juin',
            'Juillet',
            'Ao√ªt',
            'Septembre',
            'Octobre',
            'Novembre',
            'D√©cembre'
            ];
            const year = document.getElementById('year-select').value;
            const month = document.querySelector('input[name="month"]:checked')?.value || new Date().getMonth()+1;
            
            let text = '';
            switch(state.dateMode) {
                case 'focus_jour': text = `üìÖ Focus Jour : ${state.dateDebut}`; break;
                case 'focus_mois': text = `üìÖ Mois complet : ${monthNames[month-1]} ${year}`; break;
                case 'j_minus_1': text = `üìÖ J-1 (hier) : ${state.dateDebut}`; break;
                case 'semaine_minus_1': text = `üìÖ Semaine -1 : ${state.dateDebut} ‚Üí ${state.dateFin}`; break;
                case 'toute_periode': text = `üìÖ Toute la p√©riode : ${state.dateDebut} ‚Üí ${state.dateFin}`; break;
                case 'selection_manuelle': text = `üìÖ S√©lection manuelle : ${state.dateDebut} ‚Üí ${state.dateFin}`; break;
            }
            document.getElementById('period-summary').textContent = text;
            document.getElementById('sum-dates').textContent = `${state.dateDebut} ‚Üí ${state.dateFin}`;
        }
        
        // Filters change
        async function onFiltersChange() {
            try {
                await loadFilterOptions();
            } catch (e) {
                console.warn('loadFilterOptions failed:', e);
            }
            refreshTab();
        }

        // Tabs
        function buildUrl(base) {
            const p = new URLSearchParams();
            if (state.tab === 'projection') {
                if (state.projectionSites.length) p.set('sites', state.projectionSites.join(','));
                if (state.projectionHideEmpty) p.set('hide_empty', 'true');
            } else {
                if (state.sites.length && state.sites.length < state.allSites.length) p.set('sites', state.sites.join(','));
            }
            if (state.tab === 'details-site' && state.siteFocus) {
                p.set('site_focus', state.siteFocus);
                if (state.siteDetailsPdcs.length) {
                    p.set('pdc', state.siteDetailsPdcs.join(','));
                }
            }
            if (state.dateDebut) p.set('date_debut', state.dateDebut);
            if (state.dateFin) p.set('date_fin', state.dateFin);
            if (state.selectedErrorTypes.length < state.errorTypes.length) p.set('error_types', state.selectedErrorTypes.join(','));
            if (state.selectedMoments.length < state.moments.length) p.set('moments', state.selectedMoments.join(','));
            
            // Pour le tableau charges, pr√©server les super filtres depuis l'URL actuelle
            if (state.tab === 'tableau-charges') {
                const currentUrl = new URL(window.location.href);
                const currentParams = new URLSearchParams(currentUrl.search);
                const superFilterParams = ['charge_type', 'energy_max', 'vehicle_type', 'voltage_800v', 'pdc_filter', 'pmax_min', 'error_moment'];
                for (const param of superFilterParams) {
                    const value = currentParams.get(param);
                    if (value) {
                        p.set(param, value);
                    }
                }

                // Pr√©server le mode de p√©riode et ses dates propres au tableau charges
                // (les filtres globaux state.dateDebut/dateFin peuvent √™tre diff√©rents)
                const tableauPeriodType = currentParams.get('period_type');
                if (tableauPeriodType) {
                    p.set('period_type', tableauPeriodType);
                }

                if (tableauPeriodType === 'toute_periode') {
                    p.delete('date_debut');
                    p.delete('date_fin');
                } else {
                    const tableauDateDebut = currentParams.get('date_debut');
                    const tableauDateFin = currentParams.get('date_fin');
                    if (tableauDateDebut) p.set('date_debut', tableauDateDebut);
                    if (tableauDateFin) p.set('date_fin', tableauDateFin);
                }
            }
            
            return p.toString() ? `${base}?${p}` : base;
        }

        function captureTabState() {
            if (state.tab === 'details-site') {
                const pdcCheckboxes = Array.from(document.querySelectorAll('input[name="pdc-option"]:checked'));
                state.siteDetailsPdcs = pdcCheckboxes.map(el => el.value);
                const siteSelect = document.getElementById('site-focus');
                if (siteSelect && siteSelect.value) {
                    state.siteFocus = siteSelect.value;
                }
            }

            if (state.tab === 'mac-address') {
                const macInput = document.querySelector('input[name="mac_query"]');
                if (macInput) {
                    state.macSearchState = {
                        ...(state.macSearchState || {}),
                        mac_query: macInput.value.trim(),
                    };
                }
            }

            if (state.tab === 'code-analysis') {
                const codeForm = document.querySelector('.code-form');
                if (codeForm) {
                    const codes = codeForm.querySelector('input[name="codes"]')?.value.trim() || '';
                    const codeType = codeForm.querySelector('select[name="code_type"]')?.value || 'Tous';
                    state.codeAnalysisState = {
                        ...(state.codeAnalysisState || {}),
                        codes,
                        code_type: codeType,
                    };
                }
            }
        }

        function restoreTabState() {
            if (state.tab === 'details-site' && state.siteDetailsPdcs.length) {
                const pdcCheckboxes = Array.from(document.querySelectorAll('input[name="pdc-option"]'));
                if (pdcCheckboxes.length) {
                    const pdcSet = new Set(state.siteDetailsPdcs);
                    pdcCheckboxes.forEach(cb => { cb.checked = pdcSet.has(cb.value); });
                    const toggle = document.getElementById('pdc-toggle');
                    if (toggle) {
                        const allChecked = pdcCheckboxes.every(cb => cb.checked);
                        toggle.textContent = allChecked ? '‚òë Tous' : '‚òê Tous';
                    }
                }
            }

            if (state.tab === 'mac-address' && state.macSearchState) {
                const macInput = document.querySelector('input[name="mac_query"]');
                if (macInput) {
                    macInput.value = state.macSearchState.mac_query || '';
                    if (state.macSearchState.submitted && state.macSearchState.mac_query) {
                        const form = macInput.closest('form');
                        if (form) form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    }
                }
            }

            if (state.tab === 'code-analysis' && state.codeAnalysisState) {
                const codeForm = document.querySelector('.code-form');
                if (codeForm) {
                    const codesInput = codeForm.querySelector('input[name="codes"]');
                    const typeSelect = codeForm.querySelector('select[name="code_type"]');
                    if (codesInput) codesInput.value = state.codeAnalysisState.codes || '';
                    if (typeSelect) typeSelect.value = state.codeAnalysisState.code_type || 'Tous';
                    if (state.codeAnalysisState.submitted && state.codeAnalysisState.codes) {
                        codeForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    }
                }
            }
        }

        function updateProjectionSelection(selected, silent = false) {
            state.projectionSites = selected || [];
            if (!silent && state.tab === 'projection' && state.projectionSites.length) refreshTab();
        }

        function updateProjectionHideEmpty(value, silent = false) {
            state.projectionHideEmpty = !!value;
            if (!silent && state.tab === 'projection' && state.projectionSites.length) refreshTab();
        }

        function refreshTab() {
            captureTabState();
            const tabContent = document.getElementById('tab-content');
            if (tabContent) {
                tabContent.innerHTML = `<div class="loading"><span class="spinner"></span> Chargement...</div>`;
            }
            const url = buildUrl(endpoints[state.tab]);
            
            // Met √† jour l'URL dans la barre d'adresse
            // Pour tableau-charges, inclure les param√®tres de l'URL compl√®te (y compris super filtres)
            if (state.tab === 'tableau-charges') {
                // Utiliser l'URL compl√®te avec tous les param√®tres
                const dashboardUrl = `/dashboard/${state.tab}?${url.split('?')[1] || ''}`;
                window.history.pushState({tab: state.tab}, '', dashboardUrl);
            } else {
                const dashboardUrl = `/dashboard/${state.tab}`;
                window.history.pushState({tab: state.tab}, '', dashboardUrl);
            }
            
            // Charge le contenu
            htmx.ajax('GET', url, {target: '#tab-content', swap: 'innerHTML'});
        }
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault(); 
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.tab = btn.dataset.tab;
                refreshTab();
            });
        });

        document.addEventListener('click', (event) => {
            const navTarget = event.target.closest('[data-nav-tab]');
            if (navTarget) {
                const tab = navTarget.dataset.navTab;
                if (navTarget.dataset.siteFocus) {
                    state.siteFocus = navTarget.dataset.siteFocus;
                }
                const tabBtn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
                if (tabBtn) {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    tabBtn.classList.add('active');
                    state.tab = tab;
                    refreshTab();
                }
            }
        });

        document.addEventListener('submit', (event) => {
            const form = event.target;
            if (form.classList.contains('mac-search-form')) {
                const macInput = form.querySelector('input[name="mac_query"]');
                state.macSearchState = {
                    mac_query: macInput?.value.trim() || '',
                    submitted: true,
                };
            }
            if (form.classList.contains('code-form')) {
                const codes = form.querySelector('input[name="codes"]')?.value.trim() || '';
                const codeType = form.querySelector('select[name="code_type"]')?.value || 'Tous';
                state.codeAnalysisState = {
                    codes,
                    code_type: codeType,
                    submitted: true,
                };
            }
        });

        document.addEventListener('change', (event) => {
            if (event.target.id === 'site-focus') {
                state.siteFocus = event.target.value;
            }
            if (event.target.name === 'pdc-option') {
                const checked = Array.from(document.querySelectorAll('input[name="pdc-option"]:checked')).map(el => el.value);
                state.siteDetailsPdcs = checked;
            }
        });

        document.body.addEventListener('htmx:afterSwap', (event) => {
            if (event.target && event.target.id === 'tab-content') {
                restoreTabState();
            }
        });
        
        // Time
        function updateTime() {
            document.getElementById('update-time').textContent = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
        }
        
        // Init
        async function init() {
            document.getElementById('year-select').value = new Date().getFullYear();
            document.getElementById('day-input').value = fmt(new Date());
            updateDates();
            await loadSites();
            await loadFilterOptions();
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === state.tab);
            });
            
            refreshTab();
            updateTime();
            setInterval(updateTime, 60000);
        }
        
        init();
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try {
                    await fetch('/logout', { method: 'POST' });
                } finally {
                    window.location.href = '/';
                }
            });
        }
    </script>
</body>
</html>
